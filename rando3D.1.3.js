var RANDO=RANDO||{};(function(){RANDO.Dem=function(a,c,b,d){this._extent=this._prepareExtent(a,b);this._altitudes=c;this._offsets=b;this._scene=d;this._tiles=null;this._frame=null;this._textures=[];this._min_thickness=RANDO.SETTINGS.MIN_THICKNESS;this.ground=new BABYLON.Mesh("Digital Elevation Model",d);this.sides=new BABYLON.Mesh("Sides",d);this.scaleViewer=null;this.init()};RANDO.Dem.prototype.init=function(){this._adjustZoom();var a=new RANDO.TileContainer(this.getRealExtent(),this._altitudes,this._offsets);this._tiles=a._tiles;this._frame=a.getFrame();this.buildGround();this.buildSides();this.buildBasement()};RANDO.Dem.prototype._prepareExtent=function(a,b){a.x.min+=b.x;a.x.max+=b.x;a.z.min+=b.z;a.z.max+=b.z;return a};RANDO.Dem.prototype._adjustZoom=function(){while(RANDO.Utils.getNumberOfTiles(RANDO.SETTINGS.TILE_ZOOM,this.getRealExtent())>RANDO.SETTINGS.TILE_NUMBER_LIMIT){RANDO.SETTINGS.TILE_ZOOM-=1}};RANDO.Dem.prototype.buildGround=function(){console.log("Ground building... "+(Date.now()-RANDO.START_TIME));for(var a in this._tiles){var b=this._buildTile(this._tiles[a]);b.parent=this.ground;this._prepareTexture(this._tiles[a].coordinates)}console.log("Ground built ! "+(Date.now()-RANDO.START_TIME))};RANDO.Dem.prototype.buildSides=function(){console.log("Sides building... "+(Date.now()-RANDO.START_TIME));var a=-this._min_thickness;var b=this._buildSide("East Side",this._frame.east,a,false);var d=this._buildSide("West Side",this._frame.west,a,true);var c=this._buildSide("North Side",this._frame.north,a,false);var e=this._buildSide("South Side",this._frame.south,a,true);b.parent=this.sides;d.parent=this.sides;c.parent=this.sides;e.parent=this.sides;console.log("Sides built ! "+(Date.now()-RANDO.START_TIME))};RANDO.Dem.prototype.buildBasement=function(){console.log("Basement building... "+(Date.now()-RANDO.START_TIME));var a={x:this._extent.x.min,y:this._extent.z.min};var e={x:this._extent.x.max,y:this._extent.z.min};var d={x:this._extent.x.max,y:this._extent.z.max};var c={x:this._extent.x.min,y:this._extent.z.max};var b=RANDO.Utils.createGroundFromExtent("DEM Basement",a,e,d,c,1,1,this._scene);b.material=new BABYLON.StandardMaterial("Basement Material",this._scene);b.material.diffuseTexture=new BABYLON.Texture(RANDO.SETTINGS.SIDE_TEX_URL,this._scene);b.position.y-=this._min_thickness;console.log("Basement built ! "+(Date.now()-RANDO.START_TIME))};RANDO.Dem.prototype._buildTile=function(e){var f=this._scene;var b=f.getEngine();var d=this;var c=RANDO.Utils.createGroundFromGrid("Tile",e.grid,f);RANDO.Utils.computeMeshNormals(c);RANDO.Utils.setMeshUvs(c,e.uv);c.checkCollisions=true;var a=new BABYLON.StandardMaterial("DEM - Material",f);a.wireframe=true;a.backFaceCulling=false;c.material=a;return c};RANDO.Dem.prototype._buildSide=function(d,b,a,c){var f=this._scene;if(c){b.reverse()}var e=RANDO.Utils.createSideFromLine(d,b,a,f);this._computeSideUvs(e,b,a);e.material=new BABYLON.StandardMaterial(d+"Material",f);e.material.diffuseTexture=new BABYLON.Texture(RANDO.SETTINGS.SIDE_TEX_URL,f);RANDO.Utils.computeMeshNormals(e);e.checkCollisions=true;return e};RANDO.Dem.prototype.applyTextures=function(){console.log("Textures application ... "+(Date.now()-RANDO.START_TIME));var g=this._scene;var a=this.ground.getChildren();var f=this._textures;var e=[];var d=f.length;for(var c in f){e.push(false)}b();function b(){var k=0;var j=50;h();function h(){var l=j;while(l--&&k<f.length){if(!e[k]&&f[k]._texture.isReady){e[k]=true;var m=a[k].material;m.diffuseTexture=f[k];m.diffuseTexture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;m.diffuseTexture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;m.wireframe=false;d--}k++}if(k<f.length){setTimeout(h,1)}else{if(d>0){setTimeout(b,1)}else{console.log("Textures applied ! "+(Date.now()-RANDO.START_TIME))}}}}};RANDO.Dem.prototype._prepareTexture=function(d){var c=this._scene;var b=c.getEngine();var a=RANDO.Utils.replaceUrlCoordinates(RANDO.SETTINGS.TILE_TEX_URL,d.z,d.x,d.y);this._textures.push(new BABYLON.Texture(a,c))};RANDO.Dem.prototype._computeSideUvs=function(e,b,a){var c="z";if(b[b.length-1].z-b[0].z==0){c="x"}var d=[];for(var g in b){d.push(Math.abs(b[g][c]-b[0][c])*1/(Math.abs(b[b.length-1][c]-b[0][c])))}var f=[];for(var g in d){f.push(d[g]);f.push((b[g].y-a)/(this._extent.y.max-a))}for(var g in d){f.push(d[g]);f.push(0)}e.setVerticesData(BABYLON.VertexBuffer.UVKind,f)};RANDO.Dem.prototype.getRealExtent=function(){var a={};a.x={};a.y={};a.z={};a.x.min=this._extent.x.min-this._offsets.x;a.x.max=this._extent.x.max-this._offsets.x;a.y.min=this._extent.y.min;a.y.max=this._extent.y.max;a.z.min=this._extent.z.min-this._offsets.z;a.z.max=this._extent.z.max-this._offsets.z;return a}})();var RANDO=RANDO||{};RANDO.Events={};if(document.addEventListener){RANDO.Events.addEvent=function(c,b,a){c.addEventListener(b,a,false);return a};RANDO.Events.removeEvent=function(c,b,a){c.removeEventListener(b,a,false)}}else{if(document.attachEvent){RANDO.Events.addEvent=function(d,c,b){var a=function(){return b.apply(d,arguments)};d.attachEvent("on"+c,a);return a};RANDO.Events.removeEvent=function(c,b,a){c.removeEventListener("on"+b,a)}}}var RANDO=RANDO||{};(function(){RANDO.Poi=function(d,b,a,c){this._id=d;this._position={x:b.coordinates.x+a.x,y:0,z:b.coordinates.z+a.z};this._name=b.properties.name;this._type=b.properties.type;this._elevation=b.properties.elevation;this._description=b.properties.description||RANDO.SETTINGS.NO_DESCRIPTION_MESSAGE;this._scene=c;this.panel=null;this.picto=null;this.sphere=null;this._attachedLight=null;this.init()};RANDO.Poi.prototype.init=function(){this._buildPanel();this._buildSphere();var a=this;this._scene.registerBeforeRender(function(){a._registerBeforeRender()})};RANDO.Poi.prototype._buildPanel=function(){var h=this._scene;var k=this._position;var m=this._name;var b=RANDO.SETTINGS.PICTO_PREFIX+this._type.pictogram;var c=this._id;var n=this._elevation;var o={px:{width:512,height:512},m:{width:RANDO.SETTINGS.PICTO_SIZE,height:RANDO.SETTINGS.PICTO_SIZE+30}};var j={width:o.px.width,height:o.px.height*RANDO.SETTINGS.PICTO_SIZE/o.m.height};var a=BABYLON.Mesh.CreateGround("POI - Panel",o.m.width,o.m.height,2,h);a.id=c;a.rotate(BABYLON.Axis.X,-Math.PI/2,BABYLON.Space.LOCAL);a.position.x=k.x;a.position.y=-1000;a.position.z=k.z;a.material=new BABYLON.StandardMaterial("POI - Panel - Material",h);this.panel=a;var g=new BABYLON.DynamicTexture("POI - Panel - Texture",o.px.width,h,true);g.hasAlpha=true;e();var d=BABYLON.Mesh.CreateGround("POI - Panel",o.m.width,o.m.height,2,h);d.id=c;d.material=new BABYLON.StandardMaterial("POI - Picto - Material",h);d.renderingGroupId=1;this.picto=d;d.parent=a;var f=new BABYLON.DynamicTexture("POI - Picto - Texture",o.px.width,h,true);f.hasAlpha=true;l();function l(){var q=f.getContext();var p=new Image();p.onload=function(){q.drawImage(p,0,0,j.width,j.height);q.restore();f.update();d.material.diffuseTexture=f;d.material.emissiveTexture=f};p.src=b}function e(){var q=g.getContext();q.fillStyle="rgba(255, 255, 255, 0.5)";RANDO.Utils.roundRect(q,0,0,j.width,j.height,o.px.width/10);var r=n+"m";var p=(o.px.height-j.height)*RANDO.SETTINGS.POI_LABEL_SCALE;q.font="bolder "+p+"pt Arial";q.fillStyle="#fff";q.textAlign="center";q.fillText(r,o.px.width/2,o.px.height);q.restore();g.update();a.material.opacityTexture=g;a.material.emissiveTexture=g}};RANDO.Poi.prototype._buildSphere=function(){var c=this._scene;var a=this._position;var b=BABYLON.Mesh.CreateSphere("POI - Sphere",10,RANDO.SETTINGS.POI_SIZE,c);b.material=new BABYLON.StandardMaterial("POI - Sphere - Material",c);b.material.diffuseColor=new BABYLON.Color3(1,1,1);b.material.emissiveColor=new BABYLON.Color3(1,1,1);this.sphere=b};RANDO.Poi.prototype._registerBeforeRender=function(){var c=this._scene;var a=this.panel;var b=this.picto;if(BABYLON.Vector3.Distance(a.position,c.activeCamera.position)<300){a.isVisible=false;b.isVisible=false}else{a.isVisible=true;b.isVisible=true}a.lookAt(c.activeCamera.position,0,-Math.PI/2,0)};RANDO.Poi.prototype.drape=function(a){RANDO.Utils.drapePoint(this.panel.position,a,RANDO.SETTINGS.POI_OFFSET);this.sphere.position=this.panel.position.clone();this.sphere.position.y-=RANDO.SETTINGS.POI_OFFSET};RANDO.Poi.prototype.onMouseDownHandler=function(a){$(".poi--clicked").text(this._name+" ("+this._elevation+"m )");$(".poi--clicked").css("left",a.clientX-20+"px");$(".poi--clicked").css("top",a.clientY-40+"px");$(".poi--clicked").css("display","block");$(".poi_side h2").html(this._name);$(".poi_side .description").html(this._description);$(".poi_side").css("display","block");$(".interface").css("width","80%")};RANDO.Poi.prototype.onMouseOverHandler=function(a){$(".poi--hover").text(this._name+" ("+this._elevation+"m )");$(".poi--hover").css("left",a.clientX-20+"px");$(".poi--hover").css("top",a.clientY-40+"px");$(".poi--hover").css("display","block");$("#canvas_renderer")[0].style.cursor="pointer"};RANDO.Poi.runMouseListener=function(a,b,c){var d;RANDO.Events.addEvent(window,"mousedown",function(f){var g=c.pick(f.clientX,f.clientY);var e=g.pickedMesh;$(".poi--hover").css("display","none");$(".poi--clicked").css("display","none");d=-1;if(g.hit&&e.name=="POI - Panel"){b[e.id].onMouseDownHandler(f);d=e.id}});RANDO.Events.addEvent(window,"mousemove",function(f){var g=c.pick(f.clientX,f.clientY);var e=g.pickedMesh;$(".poi--hover").css("display","none");$("#canvas_renderer")[0].style.cursor="default";if(g.hit&&e.name=="POI - Panel"&&d!=e.id){b[e.id].onMouseOverHandler(f)}});$(".close_btn").on("click",function(){$(".poi_side").css("display","none");$(".interface").css("width","100%")});$(".close_btn").mouseover(function(){this.style.cursor="pointer"});$(".close_btn").mouseout(function(){this.style.cursor="default"})}})();var RANDO=RANDO||{};(function(){RANDO.Scene=function(a,c,b){this._canvas=a;this._cameraID=c;this._settings=b;this._engine=null;this._scene=null;this.camContainer=null;this.lights={};this.dem=null;this.trek=null;this.pois=[];this._dem_data={};this._trek_data=[];this._pois_data=[];this._offsets={}};RANDO.Scene.prototype.init=function(){this._engine=new BABYLON.Engine(this._canvas,true);this._scene=new BABYLON.Scene(this._engine);var a=this;RANDO.Events.addEvent(window,"resize",function(){a._engine.resize()});if(typeof(this._settings)!=="undefined"){RANDO.SETTINGS.parse(this._settings)}this._scene.clearColor=new BABYLON.Color4(0,0,0,0);this._scene.collisionsEnabled=true;this._buildLights();this.process()};RANDO.Scene.prototype.process=function(){var a=this;$.getJSON(RANDO.SETTINGS.DEM_URL).done(function(b){a._parseDemJson(b);a._buildCameras()}).then(function(){return $.getJSON(RANDO.SETTINGS.PROFILE_URL)}).done(function(b){a._parseTrekJson(b)}).then(function(){return $.getJSON(RANDO.SETTINGS.POI_URL)}).done(function(b){a._parsePoiJson(b)}).then(function(){a._engine.runRenderLoop(function(){a._scene.render()});a.dem=new RANDO.Dem(a._dem_data.extent,a._dem_data.altitudes,a._offsets,a._scene);a.trek=new RANDO.Trek(a._trek_data,a._offsets,a._scene);var c=0;for(var b in a._pois_data){if(RANDO.Utils.isInExtent(a._pois_data[b].coordinates,a.dem.getRealExtent())){a.pois.push(new RANDO.Poi(c++,a._pois_data[b],a._offsets,a._scene))}}RANDO.Poi.runMouseListener(a._canvas,a.pois,a._scene);a._scene.executeWhenReady(function(){a._executeWhenReady()})})};RANDO.Scene.prototype._buildCameras=function(){var a={demCenter:this._dem_data.center,offsets:this._offsets,demExtent:this._dem_data.extent,demAltitudes:this._dem_data.altitudes,switchEnabled:true};this.camContainer=new RANDO.CameraContainer(this._canvas,this._scene,a);if(!$.inArray(this._cameraID,RANDO.CameraIDs)){this._cameraID="examine"}this.camContainer.setActiveCamera(this._cameraID)};RANDO.Scene.prototype._buildLights=function(){var b=this._scene;this.lights.sun=a("Sun",new BABYLON.Vector3(-500,-10000,0),1.2);this.lights.sideLight1=a("Side Light 1",new BABYLON.Vector3(1,0,0.8),1.2);this.lights.sideLight2=a("Side Light 2",new BABYLON.Vector3(-1,0,-0.8),1.2);function a(e,f,c){var d=new BABYLON.DirectionalLight(e,f,b);d.intensity=c;d.specular=new BABYLON.Color4(0,0,0,0);return d}};RANDO.Scene.prototype._executeWhenReady=function(){console.log("Scene is ready ! "+(Date.now()-RANDO.START_TIME));var c=this.trek;var d=this.camContainer;var a=this.lights;a.sideLight1.excludedMeshes=this.dem.ground.getChildren();a.sideLight2.excludedMeshes=this.dem.ground.getChildren();this.dem.applyTextures();c.drape(this.dem.ground,e);for(var b in this.pois){this.pois[b].drape(this.dem.ground)}function e(){c.updateVertices();d.setAnimationPath(c._vertices);c.merge();$.merge(a.sideLight1.excludedMeshes,c.mergedTreks);$.merge(a.sideLight2.excludedMeshes,c.mergedTreks)}};RANDO.Scene.prototype._parseDemJson=function(b){var c=RANDO.Utils.toMeters(b.center);var a=RANDO.Utils.getMetersExtent(b.extent);this._dem_data.extent=a;this._dem_data.extent.y.min*=RANDO.SETTINGS.ALTITUDES_Z_SCALE;this._dem_data.extent.y.max*=RANDO.SETTINGS.ALTITUDES_Z_SCALE;this._dem_data.altitudes=RANDO.Utils.scaleArray2(b.altitudes,RANDO.SETTINGS.ALTITUDES_Z_SCALE);this._dem_data.center={x:c.x,y:(this._dem_data.extent.y.min+this._dem_data.extent.y.max)/2,z:c.y};this._offsets.x=-c.x;this._offsets.z=-c.y};RANDO.Scene.prototype._parseTrekJson=function(c){for(var b in c.profile){var a={lng:c.profile[b][2][0],lat:c.profile[b][2][1]};a=RANDO.Utils.toMeters(a);a.z=a.y;delete a.y;this._trek_data.push(a)}};RANDO.Scene.prototype._parsePoiJson=function(c){for(var b in c.features){var a=c.features[b];var d=RANDO.Utils.toMeters({lng:a.geometry.coordinates[0],lat:a.geometry.coordinates[1]});this._pois_data.push({coordinates:{x:d.x,z:d.y},properties:a.properties})}}})();var RANDO=RANDO||{};RANDO.SETTINGS={};RANDO.SETTINGS.DEM_URL;RANDO.SETTINGS.PROFILE_URL;RANDO.SETTINGS.TILE_TEX_URL;RANDO.SETTINGS.SIDE_TEX_URL;RANDO.SETTINGS.TILE_TEX_URL_SUBDOMAINS=["a","b","c"];RANDO.SETTINGS.CAM_OFFSET=200;RANDO.SETTINGS.HCAM_FOLLOW_SPEED=15;RANDO.SETTINGS.HCAM_RETURN_SPEED=1500;RANDO.SETTINGS.CAM_SPEED_F=50;RANDO.SETTINGS.COLLISIONS_OFFSET=150;RANDO.SETTINGS.ALTITUDES_Z_SCALE=1.4;RANDO.SETTINGS.LIMIT_VERT_BY_MESH=65536;RANDO.SETTINGS.TREK_SPH_TESSEL=5;RANDO.SETTINGS.TREK_CYL_TESSEL=20;RANDO.SETTINGS.MIN_THICKNESS=200;RANDO.SETTINGS.TREK_OFFSET=2;RANDO.SETTINGS.TREK_COLOR=new BABYLON.Color3(0.1,0.6,0.2);RANDO.SETTINGS.TREK_WIDTH=10;RANDO.SETTINGS.TILE_ZOOM=17;RANDO.SETTINGS.TILE_NUMBER_LIMIT=800;RANDO.SETTINGS.POI_OFFSET=100;RANDO.SETTINGS.POI_FORM1={objectName:"",folder:"blender/",fileName:"poi.babylon"};RANDO.SETTINGS.POI_SIZE=20;RANDO.SETTINGS.POI_LABEL_SCALE=1;RANDO.SETTINGS.PICTO_SIZE=100;RANDO.SETTINGS.PICTO_PREFIX="";RANDO.SETTINGS.NO_DESCRIPTION_MESSAGE="<p>Pas de description liée à ce point d'intérêt.</p>";RANDO.SETTINGS.CAMERA_MESSAGES={bird:"On peut survoler le terrain tel un oiseau, tourner la tête, monter, descendre et se déplacer !",examine:"On peut examiner le terrain en le tournant dans tous les sens.",hiker:"Ici on est dans la peau d'un randonneur, on suit sans effort l'avancement de l'itinéraire, en profitant de la vue."};RANDO.SETTINGS.SCALE_VIEWER_SIZE={width:200,height:200};RANDO.SETTINGS.SCALE_VIEWER_RESOLUTION={x:50,y:50};RANDO.SETTINGS.SCALE_VIEWER_OFFSET=20;RANDO.SETTINGS.parse=function(a){if("test" in a){}};var RANDO=RANDO||{};(function(){RANDO.TileContainer=function(a,c,b){this._extent=_.clone(a);this._altitudes=_.clone(c);this._offsets=_.clone(b);this._grid=null;this._tiles={};this._init()};RANDO.TileContainer.prototype._init=function(){this._generateTiles();this._joinTiles();this._computeSize();this._computeUvs();this.translate()};RANDO.TileContainer.prototype._generateTiles=function(){var k=RANDO.SETTINGS.TILE_ZOOM;var j=this._tiles;this._grid=RANDO.Utils.createElevationGrid(this._extent.x.min,this._extent.x.max,this._extent.z.min,this._extent.z.max,this._altitudes);var a=this._grid;var e,g=null,f,b=null,h,l=null,c=[],d=true;for(row in a){for(col in a[row]){f=a[row][col];h=RANDO.Utils.meters2num(f.x,f.z,k);e=""+k+"/"+h.xtile+"/"+h.ytile+"";j[e]=j[e]||{};if(Object.keys(j[e]).length==0){j[e].grid=[];j[e].coordinates={z:k,x:h.xtile,y:h.ytile}}if(g!=null&&g!=e){j[g].grid.push(c);c=[]}c.push(_.clone(f));g=e;b=f;d=false;l=h}d=true}j[e].grid.push(c)};RANDO.TileContainer.prototype._joinTiles=function(){var n=this._tiles;for(var g in n){var j=n[g];var q={z:j.coordinates.z,x:j.coordinates.x+1,y:j.coordinates.y};var p=""+q.z+"/"+q.x+"/"+q.y+"";if(n[p]){var a=j.grid;var o=n[p].grid;for(row in a){var b=a[row][a[row].length-1];var e=o[row][0];var l=RANDO.Utils.middle(b,e);a[row].push(l);o[row].splice(0,0,_.clone(l))}}}for(g in n){var j=_.clone(n[g]);var q={z:j.coordinates.z,x:j.coordinates.x,y:j.coordinates.y+1};var p=""+q.z+"/"+q.x+"/"+q.y+"";if(n[p]){var h=n[p];var k=_.clone(j.grid[0]);var m=_.clone(h.grid[h.grid.length-1]);var d=[];var c=[];for(var f in k){var l=RANDO.Utils.middle(k[f],m[f]);d.push(_.clone(l));c.push(_.clone(l))}j.grid.splice(0,0,d);h.grid.push(c)}}};RANDO.TileContainer.prototype._computeSize=function(){var b=this._tiles;for(var d in b){var e=b[d];var c=e.grid;var f=c.length-1;var a=c[0].length-1;e.size={width:c[0][a].x-c[0][0].x,height:c[f][0].z-c[0][0].z}}};RANDO.TileContainer.prototype._computeUvs=function(){var b=this._tiles;var h=_.max(b,function(j){return j.size.width}).size.width;var d=_.max(b,function(j){return j.size.height}).size.height;var f=this.getExtentInTilesCoordinates();for(var e in b){var g=b[e];g.uv={};if(g.coordinates.x==f.x.min){g.uv.u=a(g,h,"east")}else{if(g.coordinates.x==f.x.max){g.uv.u=a(g,h,"west")}else{g.uv.u=a(g,g.size.width,"normal")}}if(g.coordinates.y==f.y.min){g.uv.v=c(g,d,"north")}else{if(g.coordinates.y==f.y.max){g.uv.v=c(g,d,"south")}else{g.uv.v=c(g,g.size.height,"normal")}}}function a(p,k,o){if(typeof(o)==="undefined"){o="normal"}console.assert(o=="east"||o=="normal"||o=="west","uValues() function uncorrectly used");if(o=="west"){o="normal"}var l=p.grid[0].length-1;switch(o){case"east":var s=[];s[l]=1;for(var m=l-1;m>=0;m--){var q=p.grid[0][m].x;var j=p.grid[0][m+1].x;s[m]=s[m+1]-(Math.abs(j-q)/k)}return s;break;case"normal":var s=[];s[0]=0;for(var m=1;m<=l;m++){var q=p.grid[0][m].x;var r=p.grid[0][m-1].x;s[m]=s[m-1]+(Math.abs(r-q)/k)}return s;break;default:return null}}function c(n,q,l){if(typeof(l)==="undefined"){l="normal"}console.assert(l=="south"||l=="normal"||l=="north","uValues() function uncorrectly used");if(l=="north"){l="normal"}var j=n.grid.length-1;switch(l){case"south":var p=[];p[j]=1;for(var r=j-1;r>=0;r--){var k=n.grid[r][0].z;var s=n.grid[r+1][0].z;p[r]=p[r+1]-(Math.abs(s-k)/q)}p.reverse();return p;break;case"normal":var p=[];p[0]=0;for(var r=1;r<=j;r++){var k=n.grid[r][0].z;var o=n.grid[r-1][0].z;p[r]=p[r-1]+(Math.abs(o-k)/q)}p.reverse();return p;break;default:return null}}};RANDO.TileContainer.prototype.translate=function(d,b,a){var c=this._tiles;var g={};if(typeof(d)==="undefined"){g.x=this._offsets.x}else{g.x=d}if(typeof(b)==="undefined"){g.y=this._offsets.y}else{g.y=b}if(typeof(a)==="undefined"){g.z=this._offsets.z}else{g.z=a}for(var f in c){var e=c[f].grid;for(row in e){for(col in e[row]){e[row][col].x+=g.x;e[row][col].z+=g.z}}}};RANDO.TileContainer.prototype.getFrame=function(){var a={};a.east=[];a.west=[];a.north=[];a.south=[];var g=this._tiles;var j=this.getExtentInTilesCoordinates();for(var b in g){var c=g[b];if(c.coordinates.x==j.x.max){var h=c.grid[0].length-1;for(row in c.grid){a.east.push(c.grid[row][h])}}if(c.coordinates.x==j.x.min){var f=0;for(row in c.grid){a.west.push(c.grid[row][f])}}if(c.coordinates.y==j.y.min){var e=c.grid.length-1;for(col in c.grid[e]){a.south.push(c.grid[e][col])}}if(c.coordinates.y==j.y.max){var d=0;for(col in c.grid[d]){a.north.push(c.grid[d][col])}}}return a};RANDO.TileContainer.prototype.getExtentInTilesCoordinates=function(){var b={};b.x={};b.y={};var a=this._tiles;b.x.min=_.min(a,function(c){return c.coordinates.x}).coordinates.x;b.x.max=_.max(a,function(c){return c.coordinates.x}).coordinates.x;b.y.min=_.min(a,function(c){return c.coordinates.y}).coordinates.y;b.y.max=_.max(a,function(c){return c.coordinates.y}).coordinates.y;return b}})();var RANDO=RANDO||{};(function(){RANDO.Trek=function(b,a,c){this._vertices=this._prepareVertices(b,a);this._scene=c;this.spheres=null;this.cylinders=null;this.material=null;this.mergedTreks=[];this.init()};RANDO.Trek.prototype.init=function(){this.material=new BABYLON.StandardMaterial("Trek Material",this._scene);this.material.diffuseColor=RANDO.SETTINGS.TREK_COLOR;this.material.emissiveColor=RANDO.SETTINGS.TREK_COLOR;this.buildTrek()};RANDO.Trek.prototype._prepareVertices=function(d,c){var a=_.map(d,_.clone);for(var b in a){a[b].x+=c.x;a[b].y=0;a[b].z+=c.z}return a};RANDO.Trek.prototype.buildTrek=function(){console.log("Trek building... "+(Date.now()-RANDO.START_TIME));var j=this._vertices;var g=this._scene;var h=this.material;var a=new BABYLON.Mesh("TREK - Spheres",g);var f=new BABYLON.Mesh("TREK - Cylinders",g);var b=0,d=0;function k(o){b++;var n=BABYLON.Mesh.CreateSphere("Sphere "+b,RANDO.SETTINGS.TREK_SPH_TESSEL,RANDO.SETTINGS.TREK_WIDTH,g);n.position=o;n.material=h;n.parent=a}function l(n,q){d++;var o=BABYLON.Vector3.Distance(n,q);var p=BABYLON.Mesh.CreateCylinder("Cylinder "+d,1,RANDO.SETTINGS.TREK_WIDTH,RANDO.SETTINGS.TREK_WIDTH,RANDO.SETTINGS.TREK_CYL_TESSEL,g);p.material=h;p.parent=f}var c,m=null;for(var e in j){c=m;var m=new BABYLON.Vector3(j[e].x,j[e].y,j[e].z);k(m);if(c){l(c,m)}}console.log("Trek built ! "+(Date.now()-RANDO.START_TIME));this.spheres=a;this.cylinders=f};RANDO.Trek.prototype.drape=function(g,b){var a=this.spheres.getChildren();var d=this.cylinders.getChildren();var j=a.length;var f=0;var k=100;var e=this;console.log("Trek adjustments ... "+(Date.now()-RANDO.START_TIME));c();function c(){var l=k;while(l--&&f<j){RANDO.Utils.drapePoint(a[f].position,g,RANDO.SETTINGS.TREK_OFFSET);++f}if(f<j){setTimeout(c,1)}else{setTimeout(h,1)}}function h(){for(var l=0;l<j-1;l++){RANDO.Utils.placeCylinder(d[l],a[l].position,a[l+1].position)}b();console.log("Trek adjusted ! "+(Date.now()-RANDO.START_TIME))}};RANDO.Trek.prototype.merge=function(){console.log("Trek merging ... "+(Date.now()-RANDO.START_TIME));var j=this._scene;var a=this.spheres.getChildren();var h=this.cylinders.getChildren();var b=a.concat(h);var d=RANDO.SETTINGS.LIMIT_VERT_BY_MESH;var k=0;var e=0;var f=[];for(var g=0;g<b.length;g++){k+=b[g].getTotalVertices();if(k<d){b[g].isVisible=false;f.push(b[g])}else{var c=new BABYLON.Mesh("Merged Trek "+e++,j);RANDO.Utils.mergeMeshes(c,f);c.material=this.material;this.mergedTreks.push(c);f=[];f.push(b[g]);k=b[g].getTotalVertices()}}if(f.length!=0){var c=new BABYLON.Mesh("Merged Trek "+e++,j);RANDO.Utils.mergeMeshes(c,f);c.material=this.material;this.mergedTreks.push(c)}console.log("Trek merged ! "+(Date.now()-RANDO.START_TIME))};RANDO.Trek.prototype.updateVertices=function(){var b=this._vertices;var a=this.spheres.getChildren();console.assert(b.length==a.length);for(var c in a){b[c].x=a[c].position.x;b[c].y=a[c].position.y;b[c].z=a[c].position.z}};RANDO.Trek.prototype.getTotalVertices=function(){var e=this.spheres.getChildren();var b=this.cylinders.getChildren();var a=e.concat(b);var d=0;for(var c in a){d+=a[c].getTotalVertices()}return d}})();var RANDO=RANDO||{};RANDO.Utils={};RANDO.Utils.createGroundFromExtent=function(t,o,n,l,k,j,h,p,q){var g=new BABYLON.GroundMesh(t,p);var c=[];var e=[];var m=[];var f=[];var d,b;var a=RANDO.Utils.createFlatGrid(o,n,l,k,j+1,h+1);for(d=0;d<=h;d++){for(b=0;b<=j;b++){var s=a[d][b];var r=new BABYLON.Vector3(0,1,0);e.push(s.x,0,s.y);m.push(r.x,r.y,r.z);f.push(b/j,1-d/h)}}for(d=0;d<h;d++){for(b=0;b<j;b++){c.push(b+1+(d+1)*(j+1));c.push(b+1+d*(j+1));c.push(b+d*(j+1));c.push(b+(d+1)*(j+1));c.push(b+1+(d+1)*(j+1));c.push(b+d*(j+1))}}g.setVerticesData(BABYLON.VertexBuffer.PositionKind,e,q);g.setVerticesData(BABYLON.VertexBuffer.NormalKind,m,q);g.setVerticesData(BABYLON.VertexBuffer.UVKind,f,q);g.setIndices(c);return g};RANDO.Utils.createGroundFromGrid=function(b,a,h,k){var l=new BABYLON.GroundMesh(b,h);var o=[];var e=[];var n=[];var d=[];var p,c;var j=a.length-1;var g=a[0].length-1;for(p=0;p<=j;p++){g=a[p].length-1;for(c=0;c<=g;c++){var f=a[j-p][c];var m=new BABYLON.Vector3(0,1,0);e.push(f.x,f.y,f.z);n.push(m.x,m.y,m.z);d.push(c/g,1-p/j)}}for(p=0;p<j;p++){g=a[p].length-1;for(c=0;c<g;c++){o.push(c+1+(p+1)*(g+1));o.push(c+1+p*(g+1));o.push(c+p*(g+1));o.push(c+(p+1)*(g+1));o.push(c+1+(p+1)*(g+1));o.push(c+p*(g+1))}}l.setVerticesData(BABYLON.VertexBuffer.PositionKind,e,k);l.setVerticesData(BABYLON.VertexBuffer.NormalKind,n,k);l.setVerticesData(BABYLON.VertexBuffer.UVKind,d,k);l.setIndices(o);return l};RANDO.Utils.createGroundFromVertices=function(a,m,g,h,f,j){console.assert(m.length%3==0);console.assert((m.length/3)==g*h,(m.length/3)+"!="+g+"*"+h);var k=BABYLON.GroundMesh(a,f);var o=[];var e=[];var n=[];var c=[];var p,b;var d=0;for(p=0;p<=h;p++){for(b=0;b<=g;b++){var l=new BABYLON.Vector3(0,1,0);e.push(m[d],m[d+1],m[d+2]);n.push(l.x,l.y,l.z);c.push(b/g,1-p/h);d+=3}}for(p=0;p<h;p++){for(b=0;b<g;b++){o.push(b+1+(p+1)*(g+1));o.push(b+1+p*(g+1));o.push(b+p*(g+1));o.push(b+(p+1)*(g+1));o.push(b+1+(p+1)*(g+1));o.push(b+p*(g+1))}}k.setVerticesData(BABYLON.VertexBuffer.PositionKind,e,j);k.setVerticesData(BABYLON.VertexBuffer.NormalKind,n,j);k.setVerticesData(BABYLON.VertexBuffer.UVKind,c,j);k.setIndices(o);return k};RANDO.Utils.createSideFromLine=function(a,q,b,h,k){var m=new BABYLON.GroundMesh(a,h);var o=[];var e=[];var n=[];var d=[];var p,c;var j=1;var g=q.length-1;for(p=0;p<=j;p++){for(c=0;c<=g;c++){var f=q[c];var l=new BABYLON.Vector3(0,1,0);if(p==0){e.push(f.x,f.y,f.z)}else{e.push(f.x,b,f.z)}n.push(l.x,l.y,l.z);d.push(c/g,1-p/1)}}for(p=0;p<j;p++){for(c=0;c<g;c++){o.push(c+1+(p+1)*(g+1));o.push(c+1+p*(g+1));o.push(c+p*(g+1));o.push(c+(p+1)*(g+1));o.push(c+1+(p+1)*(g+1));o.push(c+p*(g+1))}}m.setVerticesData(BABYLON.VertexBuffer.PositionKind,e,k);m.setVerticesData(BABYLON.VertexBuffer.NormalKind,n,k);m.setVerticesData(BABYLON.VertexBuffer.UVKind,d,k);m.setIndices(o);return m};RANDO.Utils.placeCylinder=function(f,a,g){f.position=new BABYLON.Vector3((a.x+g.x)/2,(a.y+g.y)/2,(a.z+g.z)/2);var b=BABYLON.Vector3.Distance(a,g);f.scaling.y=b;var e=RANDO.Utils.angleFromAxis(a,g,BABYLON.Axis.X);f.rotate(BABYLON.Axis.X,e,BABYLON.Space.LOCAL);var c=new BABYLON.Vector3(a.x,g.y,g.z);var d=RANDO.Utils.angleFromPoints(a,g,c);f.rotate(BABYLON.Axis.Z,d,BABYLON.Space.LOCAL);return f};RANDO.Utils.computeMeshNormals=function(b){var a=BABYLON.VertexData.ExtractFromMesh(b);BABYLON.VertexData.ComputeNormals(a.positions,a.indices,a.normals);a.applyToMesh(b)};RANDO.Utils.setMeshUvs=function(c,a){var b=[];for(row in a.v){for(col in a.u){b.push(a.u[col]);b.push(a.v[row])}}console.assert(c.getVerticesData(BABYLON.VertexBuffer.UVKind).length==b.length,"setMeshUvs() : uvs in parameter are not well sized");c.setVerticesData(BABYLON.VertexBuffer.UVKind,b)};RANDO.Utils.mergeMeshes=function(k,g){var b=[];var e=[];var u=[];var m=[];var a=[];var c=[];var o=[];var l=[];var n=[];var h=[];var w=true;var s=true;var f=true;var x=true;var v=true;for(i=0;i!=g.length;i++){if(!g[i].isVerticesDataPresent([BABYLON.VertexBuffer.UVKind])){w=false}if(!g[i].isVerticesDataPresent([BABYLON.VertexBuffer.UV2Kind])){s=false}if(!g[i].isVerticesDataPresent([BABYLON.VertexBuffer.ColorKind])){f=false}if(!g[i].isVerticesDataPresent([BABYLON.VertexBuffer.MatricesIndicesKind])){x=false}if(!g[i].isVerticesDataPresent([BABYLON.VertexBuffer.MatricesWeightsKind])){v=false}}for(i=0;i!=g.length;i++){var j=0;var p=0;b[i]=g[i].getVerticesData(BABYLON.VertexBuffer.PositionKind);e[i]=g[i].getVerticesData(BABYLON.VertexBuffer.NormalKind);if(w){u=u.concat(g[i].getVerticesData(BABYLON.VertexBuffer.UVKind))}if(s){m=m.concat(g[i].getVerticesData(BABYLON.VertexBuffer.UV2Kind))}if(f){a=a.concat(g[i].getVerticesData(BABYLON.VertexBuffer.ColorKind))}if(x){c=c.concat(g[i].getVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind))}if(v){o=o.concat(g[i].getVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind))}var r=n.length/3;g[i].computeWorldMatrix(true);var d=g[i].getWorldMatrix();while(j<b[i].length){var q=new BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(b[i][j],b[i][j+1],b[i][j+2]),d);n.push(q.x);n.push(q.y);n.push(q.z);j=j+3}while(p<e[i].length){var q=new BABYLON.Vector3.TransformNormal(new BABYLON.Vector3(e[i][p],e[i][p+1],e[i][p+2]),d);h.push(q.x);h.push(q.y);h.push(q.z);p=p+3}if(i>0){var t=g[i].getIndices();for(it=0;it!=t.length;it++){t[it]=t[it]+r}l=l.concat(t)}else{l=g[i].getIndices()}g[i].dispose(false)}k.setVerticesData(BABYLON.VertexBuffer.PositionKind,n,false);k.setVerticesData(BABYLON.VertexBuffer.NormalKind,h,false);if(u.length>0){k.setVerticesData(BABYLON.VertexBuffer.UVKind,u,false)}if(m.length>0){k.setVerticesData(BABYLON.VertexBuffer.UV2Kind,m,false)}if(a.length>0){k.setVerticesData(BABYLON.VertexBuffer.ColorKind,a,false)}if(c.length>0){k.setVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind,c,false)}if(o.length>0){k.setVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind,o,false)}k.setIndices(l)};RANDO.Utils.getSize=function(b){var a=BABYLON.Mesh.MinMax([b]);return{width:(a.max.x-a.min.x),height:(a.max.y-a.min.y),deep:(a.max.z-a.min.z)}};RANDO.Utils.isInExtent=function(b,a){return(b.x>=a.x.min&&b.x<=a.x.max&&b.z>=a.z.min&&b.z<=a.z.max)?true:false};RANDO.Utils.getNumberOfTiles=function(f,e){var d=RANDO.Utils.meters2num(e.x.min,e.z.min,f).xtile;var b=RANDO.Utils.meters2num(e.x.max,e.z.max,f).xtile;var c=RANDO.Utils.meters2num(e.x.min,e.z.min,f).ytile;var a=RANDO.Utils.meters2num(e.x.max,e.z.max,f).ytile;return(b-d+1)*(c-a+1)};RANDO.Utils.middle=function(a,b){return{x:(a.x+b.x)/2,y:(a.y+b.y)/2,z:(a.z+b.z)/2}};RANDO.Utils.subdivide=function(c,b,a){if(c<=0){return null}if(c==1){return b}if(c==2){return[b,a]}if(c>=3){var j=(a.x-b.x)/(c-1);var h=(a.y-b.y)/(c-1);var g=b.x;var f=b.y;var e=[];e.push(b);for(var d=0;d<c-2;d++){g+=j;f+=h;e.push({x:g,y:f})}e.push(a);return e}};RANDO.Utils.createFlatGrid=function(e,d,c,b,k,m){if(m<=0){return null}if(k<=0){return null}var h=RANDO.Utils.subdivide(m,e,b);var g=RANDO.Utils.subdivide(m,d,c);var a=[];console.assert(h.length==g.length,"createGrid : west_side.length != east_side.length \n"+h.length+" != "+g.length);for(var f=0;f<m;f++){var l=RANDO.Utils.subdivide(k,h[f],g[f]);a.push(l)}return a};RANDO.Utils.createElevationGrid=function(d,h,k,f,j){var g={x:d,y:k};var e={x:h,y:k};var c={x:h,y:f};var b={x:d,y:f};var a=RANDO.Utils.createFlatGrid(g,e,c,b,j[0].length,j.length);for(row in j){for(col in j[row]){a[row][col].z=a[row][col].y;a[row][col].y=j[row][col]}}return a};RANDO.Utils.angleFromAxis=function(a,f,c){var e,b,d;switch(c){case BABYLON.Axis.X:if(a.y==f.y&&a.z==f.z){return 0}b=f.y-a.y;d=Math.sqrt(Math.pow(f.y-a.y,2)+Math.pow(f.z-a.z,2));e=Math.acos(b/d);if(f.z<a.z){return -e}return e;break;case BABYLON.Axis.Y:if(a.x==f.x&&a.z==f.z){return 0}b=f.z-a.z;d=Math.sqrt(Math.pow(f.z-a.z,2)+Math.pow(f.x-a.x,2));e=Math.acos(b/d);if(f.x<a.x){return -e}return e;break;case BABYLON.Axis.Z:if(a.x==f.x&&a.y==f.y){return 0}b=f.x-a.x;d=Math.sqrt(Math.pow(f.x-a.x,2)+Math.pow(f.y-a.y,2));e=Math.acos(b/d);if(f.y<a.y){return -e}return e}return null};RANDO.Utils.angleFromPoints=function(a,f,c){var b=BABYLON.Vector3.Distance(a,c);var d=BABYLON.Vector3.Distance(a,f);var e=Math.acos(b/d);if(c.x<f.x){return -e}return e};RANDO.Utils.roundRect=function(f,d,k,e,g,c){var j=d+e;var a=k+g;f.beginPath();f.lineWidth="4";f.moveTo(d+c,k);f.lineTo(j-c,k);f.quadraticCurveTo(j,k,j,k+c);f.lineTo(j,k+g-c);f.quadraticCurveTo(j,a,j-c,a);f.lineTo(d+c,a);f.quadraticCurveTo(d,a,d,a-c);f.lineTo(d,k+c);f.quadraticCurveTo(d,k,d+c,k);f.stroke();f.fill()};RANDO.Utils.scaleArray2=function(d,f){var a=[];for(var e in d){var b=[];for(var c in d[e]){b.push(d[e][c]*f)}a.push(b)}return a};RANDO.Utils.replaceUrlCoordinates=function(d,f,b,g){var a=RANDO.SETTINGS.TILE_TEX_URL_SUBDOMAINS,c=Math.abs(b+g)%a.length,e=a[c];d=d.replace("{s}",e);d=d.replace("{z}",f);d=d.replace("{x}",b);d=d.replace("{y}",g);return d};RANDO.Utils.toMeters=function(f){var c=6378137;var e=Math.PI/180;var a=1-1*Math.pow(10,-15);var b=Math.max(Math.min(Math.sin(f.lat*e),a),-a);return{x:c*f.lng*e,y:c*Math.log((1+b)/(1-b))/2}};RANDO.Utils.toLatlng=function(a){var b=6378137;var c=180/Math.PI;return{lat:(2*Math.atan(Math.exp(a.y/b))-(Math.PI/2))*c,lng:a.x*c/b}};RANDO.Utils.getMetersExtent=function(c){var b=RANDO.Utils.toMeters(c.northwest);var e=RANDO.Utils.toMeters(c.northeast);var a=RANDO.Utils.toMeters(c.southwest);var d=RANDO.Utils.toMeters(c.southeast);return{x:{min:Math.min(b.x,a.x),max:Math.min(e.x,d.x)},y:c.altitudes,z:{min:Math.min(a.y,d.y),max:Math.min(b.y,e.y)},}};RANDO.Utils.meters2num=function(a,d,b){var c=RANDO.Utils.toLatlng({x:a,y:d});return RANDO.Utils.deg2num(c.lat,c.lng,b)};RANDO.Utils.deg2num=function(g,e,d){var b=g*Math.PI/180;var f=Math.pow(2,d);var a=Math.floor((e+180)/360*f);var c=Math.floor((1-Math.log(Math.tan(b)+(1/Math.cos(b)))/Math.PI)/2*f);return{xtile:a,ytile:c}};RANDO.Utils.rad2num=function(c,b,e){var h=c*180/Math.PI;var f=b*180/Math.PI;var g=Math.pow(2,e);var a=Math.floor((f+180)/360*g);var d=Math.floor((1-Math.log(Math.tan(c)+(1/Math.cos(c)))/Math.PI)/2*g);return{xtile:a,ytile:d}};RANDO.Utils.drapePoint=function(b,a,f){if(typeof(f)==="undefined"){var f=0}var d=a.getChildren();var c=new BABYLON.Ray(b,BABYLON.Axis.Y);for(it in d){var e=d[it].intersects(c,true);if(e.pickedPoint){b.y=e.pickedPoint.y+f}}};"use strict";var RANDO=RANDO||{};(function(){RANDO.BirdCamera=function(b,a,c){BABYLON.Camera.call(this,b,a,c);this.moveDirection=new BABYLON.Vector3(0,0,0);this.rotationDirection=new BABYLON.Vector2(0,0);this.zoomDirection=new BABYLON.Vector3(0,0,0);this.rotation=new BABYLON.Vector3(0,0,0);this.ellipsoid=new BABYLON.Vector3(0.5,1,0.5);this._keys=[];this.keysUp=[38];this.keysDown=[40];this.keysLeft=[37];this.keysRight=[39];this._collider=new BABYLON.Collider();this._needMoveForGravity=true;this._currentTarget=BABYLON.Vector3.Zero();this._viewMatrix=BABYLON.Matrix.Zero();this._camMatrix=BABYLON.Matrix.Zero();this._cameraTransformMatrix=BABYLON.Matrix.Zero();this._cameraRotationMatrix=BABYLON.Matrix.Zero();this._referencePoint=BABYLON.Vector3.Zero();this._transformedReferencePoint=BABYLON.Vector3.Zero();this._oldPosition=BABYLON.Vector3.Zero();this._diffPosition=BABYLON.Vector3.Zero();this._newPosition=BABYLON.Vector3.Zero();this._lookAtTemp=BABYLON.Matrix.Zero();this._tempMatrix=BABYLON.Matrix.Zero();this._positionAfterZoom=BABYLON.Vector3.Zero()};RANDO.BirdCamera.prototype=Object.create(BABYLON.Camera.prototype);RANDO.BirdCamera.prototype.speed=2;RANDO.BirdCamera.prototype.checkCollisions=false;RANDO.BirdCamera.prototype.applyGravity=false;RANDO.BirdCamera.prototype.noRotationConstraint=false;RANDO.BirdCamera.prototype.angularSensibility=2000;RANDO.BirdCamera.prototype.lockedTarget=null;RANDO.BirdCamera.prototype.onCollide=null;RANDO.BirdCamera.prototype.wheelPrecision=0.3;RANDO.BirdCamera.prototype.inertialRadiusOffset=0;RANDO.BirdCamera.prototype.lowerRadiusLimit=null;RANDO.BirdCamera.prototype.upperRadiusLimit=null;RANDO.BirdCamera.prototype._getLockedTargetPosition=function(){if(!this.lockedTarget){return null}return this.lockedTarget.position||this.lockedTarget};RANDO.BirdCamera.prototype._initCache=function(){BABYLON.Camera.prototype._initCache.call(this);this._cache.lockedTarget=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.rotation=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};RANDO.BirdCamera.prototype._updateCache=function(a){if(!a){BABYLON.Camera.prototype._updateCache.call(this)}var b=this._getLockedTargetPosition();if(!b){this._cache.lockedTarget=null}else{if(!this._cache.lockedTarget){this._cache.lockedTarget=b.clone()}else{this._cache.lockedTarget.copyFrom(b)}}this._cache.rotation.copyFrom(this.rotation)};RANDO.BirdCamera.prototype._isSynchronizedViewMatrix=function(){if(!BABYLON.Camera.prototype._isSynchronizedViewMatrix.call(this)){return false}var a=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(a):!a)&&this._cache.rotation.equals(this.rotation)};RANDO.BirdCamera.prototype._computeLocalCameraSpeed=function(){return this.speed*((BABYLON.Tools.GetDeltaTime()/(BABYLON.Tools.GetFps()*10)))};RANDO.BirdCamera.prototype.setTarget=function(b){this.upVector.normalize();BABYLON.Matrix.LookAtLHToRef(this.position,b,this.upVector,this._camMatrix);this._camMatrix.invert();this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var a=b.subtract(this.position);if(a.x>=0){this.rotation.y=(-Math.atan(a.z/a.x)+Math.PI/2)}else{this.rotation.y=(-Math.atan(a.z/a.x)-Math.PI/2)}this.rotation.z=-Math.acos(BABYLON.Vector3.Dot(new BABYLON.Vector3(0,1,0),this.upVector));if(isNaN(this.rotation.x)){this.rotation.x=0}if(isNaN(this.rotation.y)){this.rotation.y=0}if(isNaN(this.rotation.z)){this.rotation.z=0}};RANDO.BirdCamera.prototype.getTarget=function(){return this._currentTarget};RANDO.BirdCamera.prototype.attachControl=function(b,e){var a;var d=this;var c=this._scene.getEngine();if(this._attachedElement){return}this._attachedElement=b;if(this._onMouseDown===undefined){this._onMouseDown=function(f){a={x:f.clientX,y:f.clientY};if(!e){f.preventDefault()}};this._onMouseUp=function(f){a=null;if(!e){f.preventDefault()}};this._onMouseOut=function(f){a=null;d._keys=[];if(!e){f.preventDefault()}};this._onMouseMove=function(g){if(!a&&!c.isPointerLock){return}var f;var h;if(!c.isPointerLock){f=g.clientX-a.x;h=g.clientY-a.y}else{f=g.movementX||g.mozMovementX||g.webkitMovementX||g.msMovementX||0;h=g.movementY||g.mozMovementY||g.webkitMovementY||g.msMovementY||0}d.rotationDirection.y+=f/d.angularSensibility;d.rotationDirection.x+=h/d.angularSensibility;a={x:g.clientX,y:g.clientY};if(!e){g.preventDefault()}};this._onWheel=function(f){var g=0;if(f.wheelDelta){g=f.wheelDelta/(d.wheelPrecision*40)}else{if(f.detail){g=-f.detail/d.wheelPrecision}}if(g){d.inertialRadiusOffset+=g}if(f.preventDefault){if(!e){f.preventDefault()}}};this._onKeyDown=function(f){if(d.keysUp.indexOf(f.keyCode)!==-1||d.keysDown.indexOf(f.keyCode)!==-1||d.keysLeft.indexOf(f.keyCode)!==-1||d.keysRight.indexOf(f.keyCode)!==-1){var g=d._keys.indexOf(f.keyCode);if(g===-1){d._keys.push(f.keyCode)}if(!e){f.preventDefault()}}};this._onKeyUp=function(f){if(d.keysUp.indexOf(f.keyCode)!==-1||d.keysDown.indexOf(f.keyCode)!==-1||d.keysLeft.indexOf(f.keyCode)!==-1||d.keysRight.indexOf(f.keyCode)!==-1){var g=d._keys.indexOf(f.keyCode);if(g>=0){d._keys.splice(g,1)}if(!e){f.preventDefault()}}};this._onLostFocus=function(){d._keys=[]};this._reset=function(){d._keys=[];a=null;d.moveDirection=new BABYLON.Vector3(0,0,0);d.rotationDirection=new BABYLON.Vector2(0,0);d.zoomDirection=new BABYLON.Vector3(0,0,0)}}b.addEventListener("mousedown",this._onMouseDown,false);b.addEventListener("mouseup",this._onMouseUp,false);b.addEventListener("mouseout",this._onMouseOut,false);b.addEventListener("mousemove",this._onMouseMove,false);b.addEventListener("mousemove",this._onMouseMove,false);b.addEventListener("mousewheel",this._onWheel,false);b.addEventListener("DOMMouseScroll",this._onWheel,false);BABYLON.Tools.RegisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}])};RANDO.BirdCamera.prototype.detachControl=function(a){if(this._attachedElement!=a){return}a.removeEventListener("mousedown",this._onMouseDown);a.removeEventListener("mouseup",this._onMouseUp);a.removeEventListener("mouseout",this._onMouseOut);a.removeEventListener("mousemove",this._onMouseMove);a.removeEventListener("mousemove",this._onMouseMove);a.removeEventListener("mousewheel",this._onWheel);a.removeEventListener("DOMMouseScroll",this._onWheel);BABYLON.Tools.UnregisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}]);this._attachedElement=null;if(this._reset){this._reset()}};RANDO.BirdCamera.prototype._collideWithWorld=function(b){var a;if(this.parent){a=BABYLON.Vector3.TransformCoordinates(this.position,this.parent.getWorldMatrix())}else{a=this.position}a.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition);this._collider.radius=this.ellipsoid;this.getScene()._getNewPosition(this._oldPosition,b,this._collider,3,this._newPosition);this._newPosition.subtractToRef(this._oldPosition,this._diffPosition);if(this._diffPosition.length()>BABYLON.Engine.CollisionsEpsilon){this.position.addInPlace(this._diffPosition);if(this.onCollide){this.onCollide(this._collider.collidedMesh)}}};RANDO.BirdCamera.prototype._checkInputs=function(){if(!this._localDirection){this._localDirection=BABYLON.Vector3.Zero();this._transformedDirection=BABYLON.Vector3.Zero()}for(var a=0;a<this._keys.length;a++){var c=this._keys[a];var b=this._computeLocalCameraSpeed();if(this.keysLeft.indexOf(c)!==-1){this._localDirection.copyFromFloats(-b,0,0)}else{if(this.keysUp.indexOf(c)!==-1){this._localDirection.copyFromFloats(0,0,b)}else{if(this.keysRight.indexOf(c)!==-1){this._localDirection.copyFromFloats(b,0,0)}else{if(this.keysDown.indexOf(c)!==-1){this._localDirection.copyFromFloats(0,0,-b)}}}}this._cameraTransformMatrix=BABYLON.Matrix.RotationY(this.rotation.y);BABYLON.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection);this.moveDirection.addInPlace(this._transformedDirection)}if(this.inertialRadiusOffset){BABYLON.Vector3.FromFloatsToRef(0,0,1,this._referencePoint);this.getViewMatrix().invertToRef(this._cameraTransformMatrix);BABYLON.Vector3.TransformNormalToRef(this._referencePoint,this._cameraTransformMatrix,this.zoomDirection);this.zoomDirection.scaleInPlace(this.inertialRadiusOffset)}};RANDO.BirdCamera.prototype._update=function(){this._checkInputs();var b=(this._needMoveForGravity||Math.abs(this.moveDirection.x)>0||Math.abs(this.moveDirection.y)>0||Math.abs(this.moveDirection.z)>0);var e=(Math.abs(this.rotationDirection.x)>0||Math.abs(this.rotationDirection.y)>0);var d=(Math.abs(this.zoomDirection.x)>0||Math.abs(this.zoomDirection.y)>0||Math.abs(this.zoomDirection.z)>0);var a=this.checkCollisions&&this._scene.collisionsEnabled;if(e){this.rotation.x+=this.rotationDirection.x;this.rotation.y+=this.rotationDirection.y;if(!this.noRotationConstraint){var c=(Math.PI/2)*0.95;if(this.rotation.x>c){this.rotation.x=c}if(this.rotation.x<-c){this.rotation.x=-c}}}if(d&&b){if(a){this._collideWithWorld(this.zoomDirection.add(this.moveDirection))}else{this.position.addInPlace(this.zoomDirection.add(this.moveDirection))}}else{if(d){if(a){this._collideWithWorld(this.zoomDirection)}else{this.position.addInPlace(this.zoomDirection)}}else{if(b){if(a){this._collideWithWorld(this.moveDirection)}else{this.position.addInPlace(this.moveDirection)}}}}if(b){if(Math.abs(this.moveDirection.x)<BABYLON.Engine.epsilon){this.moveDirection.x=0}if(Math.abs(this.moveDirection.y)<BABYLON.Engine.epsilon){this.moveDirection.y=0}if(Math.abs(this.moveDirection.z)<BABYLON.Engine.epsilon){this.moveDirection.z=0}this.moveDirection.scaleInPlace(this.inertia)}if(e){if(Math.abs(this.rotationDirection.x)<BABYLON.Engine.epsilon){this.rotationDirection.x=0}if(Math.abs(this.rotationDirection.y)<BABYLON.Engine.epsilon){this.rotationDirection.y=0}this.rotationDirection.scaleInPlace(this.inertia)}if(d){if(Math.abs(this.inertialRadiusOffset)<BABYLON.Engine.epsilon){this.inertialRadiusOffset=0}this.inertialRadiusOffset*=this.inertia}};RANDO.BirdCamera.prototype.getTarget=function(){return this._currentTarget};RANDO.BirdCamera.prototype._getViewMatrix=function(){BABYLON.Vector3.FromFloatsToRef(0,0,1,this._referencePoint);if(!this.lockedTarget){if(this.upVector.x!=0||this.upVector.y!=1||this.upVector.z!=0){BABYLON.Matrix.LookAtLHToRef(BABYLON.Vector3.Zero(),this._referencePoint,this.upVector,this._lookAtTemp);BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix);this._lookAtTemp.multiplyToRef(this._cameraRotationMatrix,this._tempMatrix);this._lookAtTemp.invert();this._tempMatrix.multiplyToRef(this._lookAtTemp,this._cameraRotationMatrix)}else{BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}BABYLON.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint);this.position.addToRef(this._transformedReferencePoint,this._currentTarget)}else{this._currentTarget.copyFrom(this._getLockedTargetPosition())}BABYLON.Matrix.LookAtLHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix);return this._viewMatrix}})();var RANDO=RANDO||{};(function(){RANDO.CameraComputer=function(a,b,e,d,f,c){this._center={x:a.x+d.x,y:a.y,z:a.z+d.z};this._totalExtent={x:{min:b.x.min+d.x,max:b.x.max+d.x},y:{min:b.y.min,max:b.y.max},z:{min:b.z.min+d.z,max:b.z.max+d.z}};this._scene=f;this._altitudes=e;this._squares=[];this._alphaSquare=null;this._number=c||5};RANDO.CameraComputer.prototype.computeInitialPositionToRef=function(a){this._generateSquares();this._findAlphaSquare();this._setPositionToRef(a)};RANDO.CameraComputer.prototype.computeInitialTargetToRef=function(a){a.x=this._center.x;a.y=0;a.z=this._center.z};RANDO.CameraComputer.prototype.computeLimitsToRef=function(a){a.lowerX=this._totalExtent.x.min;a.upperX=this._totalExtent.x.max;a.lowerZ=this._totalExtent.z.min;a.upperZ=this._totalExtent.z.max;a.lowerRadius=RANDO.SETTINGS.MIN_THICKNESS+this._center.y;a.upperRadius=8000};RANDO.CameraComputer.prototype._generateSquares=function(){var a=RANDO.Utils.createFlatGrid({x:this._totalExtent.x.min,y:this._totalExtent.z.min},{x:this._totalExtent.x.max,y:this._totalExtent.z.min},{x:this._totalExtent.x.max,y:this._totalExtent.z.max},{x:this._totalExtent.x.min,y:this._totalExtent.z.max},this._number+1,this._number+1);this._fillExtents(a);this._fillTypes();var b=RANDO.Utils.createElevationGrid(this._totalExtent.x.min,this._totalExtent.x.max,this._totalExtent.z.min,this._totalExtent.z.max,this._altitudes);this._fillIndices(b);this._fillNeighborhood()};RANDO.CameraComputer.prototype._fillExtents=function(b){for(var c=0;c<b.length-1;c++){for(var a=0;a<b[c].length-1;a++){this._squares.push({extent:{x:{min:b[c][a].x,max:b[c+1][a+1].x},z:{min:b[c][a].y,max:b[c+1][a+1].y}}})}}};RANDO.CameraComputer.prototype._fillTypes=function(){this._squares[0].type="CORNER";this._squares[this._number-1].type="CORNER";this._squares[(this._number-1)*this._number].type="CORNER";this._squares[(this._number*this._number)-1].type="CORNER";for(var a=1;a<this._number-1;a++){this._squares[a].type="EXTBORDER";this._squares[(this._number-1)*this._number+a].type="EXTBORDER";this._squares[this._number*a].type="EXTBORDER";this._squares[this._number*a+this._number-1].type="EXTBORDER"}for(var a=1;a<this._number-1;a++){this._squares[a+this._number].type="INTBORDER";this._squares[a+this._number+(this._number-3)*this._number].type="INTBORDER";this._squares[a*this._number+1].type="INTBORDER";this._squares[a*this._number+1+(this._number-3)].type="INTBORDER"}for(var b in this._squares){if(!this._squares[b].type){this._squares[b].type="BLACK"}}};RANDO.CameraComputer.prototype._fillIndices=function(e){for(var f=0;f<e.length;f++){for(var b=0;b<e[f].length;b++){var a=e[f][b];for(var c in this._squares){var d=this._squares[c];if(d.type!="BLACK"&&RANDO.Utils.isInExtent(a,d.extent)){if(d.index){d.index+=a.y;d.nb_alt++}else{d.index=a.y;d.nb_alt=1}}}}}for(var c in this._squares){var d=this._squares[c];d.index=d.index/d.nb_alt;d.index=d.index*10/(this._totalExtent.y.max-this._totalExtent.y.min);if(d.type=="BLACK"){d.index=-1}}};RANDO.CameraComputer.prototype._fillNeighborhood=function(){var c,b,a,h=[-this._number,this._number];for(var g=0;g<this._squares.length;g++){var f=this._squares[g];if(f.type=="CORNER"){f.neighborhood=[];if(g%this._number==0){c=1}else{c=-1}if(this._squares[g+this._number]){b=this._number}else{b=-this._number}f.neighborhood.push(g);f.neighborhood.push(g+c);f.neighborhood.push(g+2*c);f.neighborhood.push(g+b);f.neighborhood.push(g+2*b);f.neighborhood.push(g+c+b)}else{if(f.type=="EXTBORDER"){f.neighborhood=[];if(g%this._number==0){a=[0,1]}else{if(g%this._number==this._number-1){a=[-1,0]}else{a=[-1,0,1]}}for(var e in a){f.neighborhood.push(g+a[e]);for(var d in h){if(this._squares[g+h[d]]){f.neighborhood.push(g+a[e]+h[d])}}}}else{f.neighborhood=[]}}}};RANDO.CameraComputer.prototype._findAlphaSquare=function(){var a=this;this._alphaSquare=_.min(this._squares,function(d){var b=0;if(!d.neighborhood.length){return Infinity}for(var c in d.neighborhood){b+=a._squares[d.neighborhood[c]].index}return b})};RANDO.CameraComputer.prototype._setPositionToRef=function(b){var a=new BABYLON.Vector3((this._alphaSquare.extent.x.max+this._alphaSquare.extent.x.min)/2,0,(this._alphaSquare.extent.z.max+this._alphaSquare.extent.z.min)/2);var d=new BABYLON.Vector3(this._center.x,this._center.y,this._center.z);var f=2.5;var c=a.subtract(d).scale(f);var e=c.add(d);b.x=e.x;b.y=this._center.y+(this._totalExtent.y.max-this._totalExtent.y.min);b.z=e.z};RANDO.CameraComputer.prototype._buildSquareViewer=function(){for(var b in this._squares){var a=BABYLON.Mesh.CreateSphere("Square "+b,10,100,this._scene);a.position.x=(this._squares[b].extent.x.min+this._squares[b].extent.x.max)/2;a.position.y=this._totalExtent.y.max;a.position.z=(this._squares[b].extent.z.min+this._squares[b].extent.z.max)/2;a.material=new BABYLON.StandardMaterial("Square "+b+" - Material",this._scene);if(this._alphaSquare==this._squares[b]){a.material.diffuseColor=new BABYLON.Color3(1,0,0)}else{if(this._squares[b].type=="CORNER"){a.material.diffuseColor=new BABYLON.Color3(0,1,0)}else{if(this._squares[b].type=="EXTBORDER"){a.material.diffuseColor=new BABYLON.Color3(0,1,1)}else{if(this._squares[b].type=="INTBORDER"){a.material.diffuseColor=new BABYLON.Color3(1,0.5,0)}else{if(this._squares[b].type=="BLACK"){a.material.diffuseColor=new BABYLON.Color3(0,0,0)}}}}}}var a=BABYLON.Mesh.CreateSphere("Center",10,100,this._scene);a.position.x=this._center.x;a.position.y=this._totalExtent.y.max;a.position.z=this._center.z}})();var RANDO=RANDO||{};(function(){RANDO.CameraContainer=function(a,b,c){this._canvas=a;this._scene=b;this._switchEnabled=c.switchEnabled||false;this._computer=new RANDO.CameraComputer(c.demCenter,c.demExtent,c.demAltitudes,c.offsets||BABYLON.Vector3.Zero(),b,6);this.cameras={};this._animationPath=null;this._controlsAttached=false;this._positionBeforeSwitch=null;this._targetBeforeSwitch=null;this.initialPosition=BABYLON.Vector3.Zero();this.initialTarget=BABYLON.Vector3.Zero();this.limits={lowerX:null,upperX:null,lowerZ:null,upperZ:null,lowerRadius:null,upperRadius:null};this.init()};RANDO.CameraIDs=["examine","bird","hiker"];RANDO.CameraContainer.prototype.init=function(){this._computeInitialParameters();this._buildBirdCamera();this._buildExamineCamera();this._buildHikerCamera();this._initInterface();this._cameraSwitcher()};RANDO.CameraContainer.prototype._buildExamineCamera=function(){var a=new RANDO.ExamineCamera("Examine Camera",0,0,0,this.initialTarget,this._scene);a.id="examine";a.keysUp=[90,38];a.keysDown=[83,40];a.keysLeft=[81,37];a.keysRight=[68,39];a.wheelPrecision=0.2;a.checkCollisions=true;a.ellipsoid.y=RANDO.SETTINGS.COLLISIONS_OFFSET;a.maxZ=50000;a.speed=RANDO.SETTINGS.CAM_SPEED_F;a.lowerXLimit=this.limits.lowerX;a.lowerZLimit=this.limits.lowerZ;a.upperXLimit=this.limits.upperX;a.upperZLimit=this.limits.upperZ;a.upperBetaLimit=Math.PI/2;this.cameras.examine=a};RANDO.CameraContainer.prototype._buildBirdCamera=function(){var a=new RANDO.BirdCamera("Bird Camera",BABYLON.Vector3.Zero(),this._scene);a.id="bird";a.keysUp=[90,38];a.keysDown=[83,40];a.keysLeft=[81,37];a.keysRight=[68,39];a.checkCollisions=true;a.ellipsoid.y=RANDO.SETTINGS.COLLISIONS_OFFSET;a.maxZ=50000;a.speed=RANDO.SETTINGS.CAM_SPEED_F;this.cameras.bird=a};RANDO.CameraContainer.prototype._buildHikerCamera=function(){var a=new RANDO.HikerCamera("Hiker Camera",BABYLON.Vector3.Zero(),this._scene);a.id="hiker";a.checkCollisions=true;a.maxZ=50000;a.returnSpeed=RANDO.SETTINGS.HCAM_RETURN_SPEED;a.followSpeed=RANDO.SETTINGS.HCAM_FOLLOW_SPEED;this.cameras.hiker=a};RANDO.CameraContainer.prototype.setActiveCamera=function(a){if(RANDO.CameraIDs.indexOf(a)==-1){console.error("RANDO.CameraContainer.setActiveCamera () : "+a+" is not an available camera's ID");return}var b=this._scene.activeCamera.id;this._recordInfoBeforeSwitch(b);if(this._controlsAttached){this.cameras[b].detachControl()}this.cameras[a].attachControl(this._canvas);this._controlsAttached=true;this._scene.setActiveCameraByID(a);this._resetByDefault();$(".controls--"+b).css("display","none");$(".camera--"+b).removeClass("camera--selected");$(".controls--"+a).css("display","block");$(".camera--"+a).addClass("camera--selected")};RANDO.CameraContainer.prototype._recordInfoBeforeSwitch=function(a){if(a=="examine"){this._positionBeforeSwitch=this._scene.activeCamera.position.clone();this._targetBeforeSwitch=this._scene.activeCamera.target.clone();this._rotationBeforeSwitch=null}else{if(a=="bird"||a=="hiker"){this._positionBeforeSwitch=this._scene.activeCamera.position.clone();this._rotationBeforeSwitch=this._scene.activeCamera.rotation.clone();this._targetBeforeSwitch=null}}};RANDO.CameraContainer.prototype.setAnimationPath=function(a){this._animationPath=a;this.cameras.hiker.setPath(a);this.enableCamera("hiker")};RANDO.CameraContainer.prototype._cameraSwitcher=function(){var b=RANDO.CameraIDs;var c=this;if(!this._switchEnabled){return}else{$(".camera_switcher").css("display","block")}for(var a in b){if(b[a]!="hiker"){this.enableCamera(b[a])}$(".camera--"+b[a]).click({id:b[a]},function(d){if($(this).hasClass("camera--disabled")){return}else{c.setActiveCamera(d.data.id)}})}};RANDO.CameraContainer.prototype.enableCamera=function(a){$(".camera--"+a).removeClass("camera--disabled");$(".camera--"+a).addClass("camera--enabled");$(".camera--"+a+" img").attr("src","img/camera.png")};RANDO.CameraContainer.prototype._resetByDefault=function(){var a=this._scene.activeCamera;if(a.id=="examine"){a.setPosition(this.initialPosition.clone());a.target=this.initialTarget.clone()}else{if(a.id=="bird"){a.position=this.initialPosition.clone();a.setTarget(this.initialTarget.clone())}else{if(a.id=="hiker"){if(this._positionBeforeSwitch){a.position=this._positionBeforeSwitch}if(this._rotationBeforeSwitch){a.rotation=this._rotationBeforeSwitch}if(this._targetBeforeSwitch){a.setTarget(this._targetBeforeSwitch)}}}}a._reset()};RANDO.CameraContainer.prototype._computeInitialParameters=function(){this._computer.computeInitialPositionToRef(this.initialPosition);this._computer.computeInitialTargetToRef(this.initialTarget);this._computer.computeLimitsToRef(this.limits)};RANDO.CameraContainer.prototype._initInterface=function(){for(var a in this.cameras){var b=this.cameras[a].id;$(".controls--"+b+" .controls-description").text(RANDO.SETTINGS.CAMERA_MESSAGES[b]);$(".camera--"+b+" .camera-description").text(RANDO.SETTINGS.CAMERA_MESSAGES[b])}}})();"use strict";var RANDO=RANDO||{};(function(){var a=BABYLON.Tools.GetPointerPrefix();RANDO.ExamineCamera=function(c,g,f,b,e,d){BABYLON.Camera.call(this,c,RANDO.ExamineCamera.sphericToCartesian(g,f,b,e),d);this.alpha=g;this.beta=f;this.radius=b;this.target=e;this._keys=[];this.keysUp=[38];this.keysDown=[40];this.keysLeft=[37];this.keysRight=[39];this._collider=new BABYLON.Collider();this._needMoveForGravity=true;this.cameraDirection=new BABYLON.Vector3(0,0,0);this.cameraRotation=new BABYLON.Vector2(0,0);this.rotation=new BABYLON.Vector3(0,0,0);this.ellipsoid=new BABYLON.Vector3(0.5,1,0.5);this._viewMatrix=BABYLON.Matrix.Zero();this._cameraTransformMatrix=BABYLON.Matrix.Zero();this._oldPosition=BABYLON.Vector3.Zero();this._diffPosition=BABYLON.Vector3.Zero();this._newPosition=BABYLON.Vector3.Zero()};RANDO.ExamineCamera.prototype=Object.create(BABYLON.Camera.prototype);RANDO.ExamineCamera.prototype.inertialAlphaOffset=0;RANDO.ExamineCamera.prototype.inertialBetaOffset=0;RANDO.ExamineCamera.prototype.inertialRadiusOffset=0;RANDO.ExamineCamera.prototype.lowerAlphaLimit=null;RANDO.ExamineCamera.prototype.upperAlphaLimit=null;RANDO.ExamineCamera.prototype.lowerBetaLimit=0.01;RANDO.ExamineCamera.prototype.upperBetaLimit=Math.PI;RANDO.ExamineCamera.prototype.lowerRadiusLimit=null;RANDO.ExamineCamera.prototype.upperRadiusLimit=null;RANDO.ExamineCamera.prototype.lowerXLimit=null;RANDO.ExamineCamera.prototype.upperXLimit=null;RANDO.ExamineCamera.prototype.lowerZLimit=null;RANDO.ExamineCamera.prototype.upperZLimit=null;RANDO.ExamineCamera.prototype.angularSensibility=1000;RANDO.ExamineCamera.prototype.wheelPrecision=3;RANDO.ExamineCamera.prototype._getTargetPosition=function(){return this.target.position||this.target};RANDO.ExamineCamera.prototype._initCache=function(){BABYLON.Camera.prototype._initCache.call(this);this._cache.target=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.alpha=undefined;this._cache.beta=undefined;this._cache.radius=undefined};RANDO.ExamineCamera.prototype._updateCache=function(b){if(!b){BABYLON.Camera.prototype._updateCache.call(this)}this._cache.target.copyFrom(this._getTargetPosition());this._cache.alpha=this.alpha;this._cache.beta=this.beta;this._cache.radius=this.radius};RANDO.ExamineCamera.prototype._isSynchronizedViewMatrix=function(){if(!BABYLON.Camera.prototype._isSynchronizedViewMatrix.call(this)){return false}return this._cache.target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius};RANDO.ExamineCamera.prototype._computeLocalCameraSpeed=function(){return this.speed*((BABYLON.Tools.GetDeltaTime()/(BABYLON.Tools.GetFps()*10)))};RANDO.ExamineCamera.prototype.attachControl=function(c,f){var b;var e=this;var g;if(this._attachedElement){return}this._attachedElement=c;var d=this._scene.getEngine();if(this._onPointerDown===undefined){this._onPointerDown=function(h){if(g){return}g=h.pointerId;b={x:h.clientX,y:h.clientY};if(!f){h.preventDefault()}};this._onPointerUp=function(h){b=null;g=null;if(!f){h.preventDefault()}};this._onPointerMove=function(j){if(!b){return}if(g!==j.pointerId){return}var h=j.clientX-b.x;var k=j.clientY-b.y;e.inertialAlphaOffset-=h/e.angularSensibility;e.inertialBetaOffset-=k/e.angularSensibility;b={x:j.clientX,y:j.clientY};if(!f){j.preventDefault()}};this._onMouseMove=function(j){if(!d.isPointerLock){return}var h=j.movementX||j.mozMovementX||j.webkitMovementX||j.msMovementX||0;var k=j.movementY||j.mozMovementY||j.webkitMovementY||j.msMovementY||0;e.inertialAlphaOffset-=h/e.angularSensibility;e.inertialBetaOffset-=k/e.angularSensibility;if(!f){j.preventDefault()}};this._wheel=function(h){var j=0;if(h.wheelDelta){j=h.wheelDelta/(e.wheelPrecision*40)}else{if(h.detail){j=-h.detail/e.wheelPrecision}}if(j){e.inertialRadiusOffset+=j}if(h.preventDefault){if(!f){h.preventDefault()}}};this._onKeyDown=function(h){if(e.keysUp.indexOf(h.keyCode)!==-1||e.keysDown.indexOf(h.keyCode)!==-1||e.keysLeft.indexOf(h.keyCode)!==-1||e.keysRight.indexOf(h.keyCode)!==-1){var j=e._keys.indexOf(h.keyCode);if(j===-1){e._keys.push(h.keyCode)}if(h.preventDefault){if(!f){h.preventDefault()}}}};this._onKeyUp=function(h){if(e.keysUp.indexOf(h.keyCode)!==-1||e.keysDown.indexOf(h.keyCode)!==-1||e.keysLeft.indexOf(h.keyCode)!==-1||e.keysRight.indexOf(h.keyCode)!==-1){var j=e._keys.indexOf(h.keyCode);if(j>=0){e._keys.splice(j,1)}if(h.preventDefault){if(!f){h.preventDefault()}}}};this._onLostFocus=function(){e._keys=[];g=null};this._onGestureStart=function(h){if(window.MSGesture===undefined){return}if(!e._MSGestureHandler){e._MSGestureHandler=new MSGesture();e._MSGestureHandler.target=canvas}e._MSGestureHandler.addPointer(h.pointerId)};this._onGesture=function(h){e.radius*=h.scale;if(h.preventDefault){if(!f){h.stopPropagation();h.preventDefault()}}};this._reset=function(){e._keys=[];e.inertialAlphaOffset=0;e.inertialBetaOffset=0;e.inertialRadiusOffset=0;e.cameraDirection=new BABYLON.Vector3(0,0,0);b=null;g=null}}c.addEventListener(a+"down",this._onPointerDown,false);c.addEventListener(a+"up",this._onPointerUp,false);c.addEventListener(a+"out",this._onPointerUp,false);c.addEventListener(a+"move",this._onPointerMove,false);c.addEventListener("mousemove",this._onMouseMove,false);c.addEventListener("MSPointerDown",this._onGestureStart,false);c.addEventListener("MSGestureChange",this._onGesture,false);c.addEventListener("mousewheel",this._wheel,false);c.addEventListener("DOMMouseScroll",this._wheel,false);BABYLON.Tools.RegisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}])};RANDO.ExamineCamera.prototype.detachControl=function(b){if(this._attachedElement!=b){return}b.removeEventListener(a+"down",this._onPointerDown);b.removeEventListener(a+"up",this._onPointerUp);b.removeEventListener(a+"out",this._onPointerUp);b.removeEventListener(a+"move",this._onPointerMove);b.removeEventListener("mousemove",this._onMouseMove);b.removeEventListener("MSPointerDown",this._onGestureStart);b.removeEventListener("MSGestureChange",this._onGesture);b.removeEventListener("mousewheel",this._wheel);b.removeEventListener("DOMMouseScroll",this._wheel);BABYLON.Tools.UnregisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}]);this._MSGestureHandler=null;this._attachedElement=null;if(this._reset){this._reset()}};RANDO.ExamineCamera.prototype._collideWithWorld=function(c){var b;if(this.parent){b=BABYLON.Vector3.TransformCoordinates(this.position,this.parent.getWorldMatrix())}else{b=this.position}b.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition);this._collider.radius=this.ellipsoid;this.getScene()._getNewPosition(this._oldPosition,c,this._collider,3,this._newPosition);this._newPosition.subtractToRef(this._oldPosition,this._diffPosition);if(this._diffPosition.length()>BABYLON.Engine.CollisionsEpsilon){this.position.addInPlace(this._diffPosition);this.setPosition(this.position);if(this.onCollide){this.onCollide(this._collider.collidedMesh)}}};RANDO.ExamineCamera.prototype._checkInputs=function(){if(!this._localDirection){this._localDirection=BABYLON.Vector3.Zero();this._transformedDirection=BABYLON.Vector3.Zero()}for(var b=0;b<this._keys.length;b++){var d=this._keys[b];var c=this._computeLocalCameraSpeed();if(this.keysLeft.indexOf(d)!==-1){this._localDirection.copyFromFloats(-c,0,0)}else{if(this.keysUp.indexOf(d)!==-1){this._localDirection.copyFromFloats(c,0,0)}else{if(this.keysRight.indexOf(d)!==-1){this._localDirection.copyFromFloats(c,0,0)}else{if(this.keysDown.indexOf(d)!==-1){this._localDirection.copyFromFloats(-c,0,0)}}}}this.getViewMatrix().invertToRef(this._cameraTransformMatrix);BABYLON.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection);if(this.keysUp.indexOf(d)!==-1||this.keysDown.indexOf(d)!==-1){this.cameraDirection.addInPlace(BABYLON.Vector3.TransformNormal(this._transformedDirection,BABYLON.Matrix.RotationY(-Math.PI/2)))}else{this.cameraDirection.addInPlace(this._transformedDirection)}}};RANDO.ExamineCamera.prototype._update=function(){this._checkInputs();var d=(Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0);var c=(this.inertialAlphaOffset!=0||this.inertialBetaOffset!=0||this.inertialRadiusOffset!=0);var b=this.checkCollisions&&this._scene.collisionsEnabled;if(d){this.target.addInPlace(this.cameraDirection)}if(c){this.alpha+=this.inertialAlphaOffset;this.beta+=this.inertialBetaOffset;this.radius-=this.inertialRadiusOffset}if(this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit){this.alpha=this.lowerAlphaLimit;this.inertialAlphaOffset=0}if(this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit){this.alpha=this.upperAlphaLimit;this.inertialAlphaOffset=0}if(this.lowerBetaLimit&&this.beta<this.lowerBetaLimit){this.beta=this.lowerBetaLimit;this.inertialBetaOffset=0}if(this.upperBetaLimit&&this.beta>this.upperBetaLimit){this.beta=this.upperBetaLimit;this.inertialBetaOffset=0}if(this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit){this.radius=this.lowerRadiusLimit;this.inertialRadiusOffset=0}if(this.upperRadiusLimit&&this.radius>this.upperRadiusLimit){this.radius=this.upperRadiusLimit;this.inertialRadiusOffset=0}if(this.lowerXLimit&&this.target.x<this.lowerXLimit){this.target.x=this.lowerXLimit;this.cameraDirection.x=0}if(this.upperXLimit&&this.target.x>this.upperXLimit){this.target.x=this.upperXLimit;this.cameraDirection.x=0}if(this.lowerZLimit&&this.target.z<this.lowerZLimit){this.target.z=this.lowerZLimit;this.cameraDirection.z=0}if(this.upperZLimit&&this.target.z>this.upperZLimit){this.target.z=this.upperZLimit;this.cameraDirection.z=0}if(c&&d){if(b){this._collideWithWorld(RANDO.ExamineCamera.sphericToCartesian(this.alpha,this.beta,this.radius,this.target).subtract(this.position).add(this.cameraDirection))}else{this.position.addInPlace(RANDO.ExamineCamera.sphericToCartesian(this.alpha,this.beta,this.radius,this.target).subtract(this.position).add(this.cameraDirection));this.setPosition(this.position)}}else{if(c){if(b){this._collideWithWorld(RANDO.ExamineCamera.sphericToCartesian(this.alpha,this.beta,this.radius,this.target).subtract(this.position))}else{this.position.addInPlace(RANDO.ExamineCamera.sphericToCartesian(this.alpha,this.beta,this.radius,this.target).subtract(this.position));this.setPosition(this.position)}}else{if(d){if(b){this._collideWithWorld(this.cameraDirection)}else{this.position.addInPlace(this.cameraDirection);this.setPosition(this.position)}}}}if(d){if(Math.abs(this.cameraDirection.x)<BABYLON.Engine.Epsilon){this.cameraDirection.x=0}if(Math.abs(this.cameraDirection.y)<BABYLON.Engine.Epsilon){this.cameraDirection.y=0}if(Math.abs(this.cameraDirection.z)<BABYLON.Engine.Epsilon){this.cameraDirection.z=0}this.cameraDirection.scaleInPlace(this.inertia)}if(c){if(Math.abs(this.inertialAlphaOffset)<BABYLON.Engine.Epsilon){this.inertialAlphaOffset=0}if(Math.abs(this.inertialBetaOffset)<BABYLON.Engine.Epsilon){this.inertialBetaOffset=0}if(Math.abs(this.inertialRadiusOffset)<BABYLON.Engine.Epsilon){this.inertialRadiusOffset=0}this.inertialAlphaOffset*=this.inertia;this.inertialBetaOffset*=this.inertia;this.inertialRadiusOffset*=this.inertia}};RANDO.ExamineCamera.prototype.setPosition=function(b){this.position=b;var c=b.subtract(this._getTargetPosition());this.radius=c.length();this.alpha=Math.acos(c.x/Math.sqrt(Math.pow(c.x,2)+Math.pow(c.z,2)));if(c.z<0){this.alpha=2*Math.PI-this.alpha}this.beta=Math.acos(c.y/this.radius)};RANDO.ExamineCamera.prototype._getViewMatrix=function(){BABYLON.Matrix.LookAtLHToRef(this.position,this.target,this.upVector,this._viewMatrix);return this._viewMatrix};RANDO.ExamineCamera.ZOOM_ON_FACTOR=1;RANDO.ExamineCamera.prototype.zoomOn=function(b){b=b||this._scene.meshes;var c=BABYLON.Mesh.MinMax(b);var d=BABYLON.Vector3.Distance(c.min,c.max);this.radius=d*RANDO.ExamineCamera.ZOOM_ON_FACTOR;this.focusOn({min:c.min,max:c.max,distance:d})};RANDO.ExamineCamera.prototype.focusOn=function(b){var d;var c;if(b.min===undefined){d=b||this._scene.meshes;d=BABYLON.Mesh.MinMax(d);c=BABYLON.Vector3.Distance(d.min,d.max)}else{d=b;c=b.distance}this.target=BABYLON.Mesh.Center(d);this.maxZ=c*2};RANDO.ExamineCamera.sphericToCartesian=function(j,h,c,b){var g=Math.cos(j);var f=Math.sin(j);var e=Math.cos(h);var d=Math.sin(h);b=b||BABYLON.Vector3.Zero();return b.add(new BABYLON.Vector3(c*g*d,c*e,c*f*d))};RANDO.ExamineCamera.cartesianToSpheric=function(d,c){var e=d.subtract(c);var b=e.length();var g=Math.acos(e.x/Math.sqrt(Math.pow(e.x,2)+Math.pow(e.z,2)));if(e.z<0){var g=2*Math.PI-this.alpha}var f=Math.acos(e.y/this.radius);return{alpha:g,beta:f,radius:b}}})();"use strict";var RANDO=RANDO||{};(function(){RANDO.HikerCamera=function(b,a,c){BABYLON.Camera.call(this,b,a,c);this.cameraRotation=new BABYLON.Vector2(0,0);this.rotation=new BABYLON.Vector3(0,0,0);this.keysPlayPause=[32];this.keysStop=[13];this.keysRewind=[40];this.keysForward=[38];this._currentTarget=BABYLON.Vector3.Zero();this._viewMatrix=BABYLON.Matrix.Zero();this._camMatrix=BABYLON.Matrix.Zero();this._cameraRotationMatrix=BABYLON.Matrix.Zero();this._referencePoint=BABYLON.Vector3.Zero();this._transformedReferencePoint=BABYLON.Vector3.Zero();this._lookAtTemp=BABYLON.Matrix.Zero();this._tempMatrix=BABYLON.Matrix.Zero();this._timeline=null;this._path=[];this._state=null;this._oldState=null;this._isMoving=false;this._lenghtOfBezier=0;this._positionTween=null;this._rotationTween=null};RANDO.HikerCamera.prototype=Object.create(BABYLON.Camera.prototype);RANDO.HikerCamera.prototype.returnSpeed=2000;RANDO.HikerCamera.prototype.followSpeed=20;RANDO.HikerCamera.prototype.checkCollisions=false;RANDO.HikerCamera.prototype.applyGravity=false;RANDO.HikerCamera.prototype.noRotationConstraint=false;RANDO.HikerCamera.prototype.angularSensibility=2000;RANDO.HikerCamera.prototype.lockedTarget=null;RANDO.HikerCamera.prototype.onCollide=null;RANDO.HikerCamera.prototype.wheelPrecision=0.3;RANDO.HikerCamera.prototype.inertialRadiusOffset=0;RANDO.HikerCamera.prototype.lowerRadiusLimit=null;RANDO.HikerCamera.prototype.upperRadiusLimit=null;RANDO.HikerCamera.prototype._getLockedTargetPosition=function(){if(!this.lockedTarget){return null}return this.lockedTarget.position||this.lockedTarget};RANDO.HikerCamera.prototype._initCache=function(){BABYLON.Camera.prototype._initCache.call(this);this._cache.lockedTarget=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.rotation=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};RANDO.HikerCamera.prototype._updateCache=function(a){if(!a){BABYLON.Camera.prototype._updateCache.call(this)}var b=this._getLockedTargetPosition();if(!b){this._cache.lockedTarget=null}else{if(!this._cache.lockedTarget){this._cache.lockedTarget=b.clone()}else{this._cache.lockedTarget.copyFrom(b)}}this._cache.rotation.copyFrom(this.rotation)};RANDO.HikerCamera.prototype._isSynchronizedViewMatrix=function(){if(!BABYLON.Camera.prototype._isSynchronizedViewMatrix.call(this)){return false}var a=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(a):!a)&&this._cache.rotation.equals(this.rotation)};RANDO.HikerCamera.prototype.setTarget=function(b){this.upVector.normalize();BABYLON.Matrix.LookAtLHToRef(this.position,b,this.upVector,this._camMatrix);this._camMatrix.invert();this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var a=b.subtract(this.position);if(a.x>=0){this.rotation.y=(-Math.atan(a.z/a.x)+Math.PI/2)}else{this.rotation.y=(-Math.atan(a.z/a.x)-Math.PI/2)}this.rotation.z=-Math.acos(BABYLON.Vector3.Dot(new BABYLON.Vector3(0,1,0),this.upVector));if(isNaN(this.rotation.x)){this.rotation.x=0}if(isNaN(this.rotation.y)){this.rotation.y=0}if(isNaN(this.rotation.z)){this.rotation.z=0}};RANDO.HikerCamera.prototype.attachControl=function(b,e){var a;var d=this;var c=this._scene.getEngine();if(this._attachedElement){return}this._attachedElement=b;if(this._onMouseDown===undefined){this._onMouseDown=function(f){a={x:f.clientX,y:f.clientY};if(!e){f.preventDefault()}};this._onMouseUp=function(f){a=null;if(!e){f.preventDefault()}};this._onMouseOut=function(f){a=null;d._keys=[];if(!e){f.preventDefault()}};this._onMouseMove=function(g){if(!a&&!c.isPointerLock){return}var f;var h;if(!c.isPointerLock){f=g.clientX-a.x;h=g.clientY-a.y}else{f=g.movementX||g.mozMovementX||g.webkitMovementX||g.msMovementX||0;h=g.movementY||g.mozMovementY||g.webkitMovementY||g.msMovementY||0}d.cameraRotation.y+=f/d.angularSensibility;d.cameraRotation.x+=h/d.angularSensibility;a={x:g.clientX,y:g.clientY};if(!e){g.preventDefault()}};this._onKeyDown=function(f){var h=d._state;var g=h;if(d._path.length&&!d._isMoving){var j=f.keyCode;if(d.keysRewind.indexOf(j)!==-1){if(h=="pause"){h="rewind"}}else{if(d.keysForward.indexOf(j)!==-1){if(h=="pause"||h=="stop"){h="forward"}}}d._oldState=g;d._state=h}};this._onKeyUp=function(f){var h=d._state;var g=h;if(d._path.length&&!d._isMoving){var j=f.keyCode;if(d.keysPlayPause.indexOf(j)!==-1){if(h=="stop"||h=="pause"){h="play"}else{if(h=="play"){h="pause"}}}else{if(d.keysStop.indexOf(j)!==-1){if(h=="play"||h=="pause"||!h){h="stop"}}else{if(d.keysRewind.indexOf(j)!==-1){if(h=="rewind"&&d._timeline._time==0){h="stop"}else{if(h=="rewind"&&d._timeline._time!=0){h="pause"}}}else{if(d.keysForward.indexOf(j)!==-1){if(h=="forward"){h="pause"}}}}}d._oldState=g;d._state=h}};this._onLostFocus=function(){d._keys=[]};this._reset=function(){d._keys=[];a=null;d.cameraRotation=new BABYLON.Vector2(0,0);if(d._path.length){d.loadPathOnTimeline()}d._oldState=null;d._state="stop";if(d._position_transition){d._position_transition.kill()}if(d._rotation_transition){d._rotation_transition.kill()}}}b.addEventListener("mousedown",this._onMouseDown,false);b.addEventListener("mouseup",this._onMouseUp,false);b.addEventListener("mouseout",this._onMouseOut,false);b.addEventListener("mousemove",this._onMouseMove,false);BABYLON.Tools.RegisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}])};RANDO.HikerCamera.prototype.detachControl=function(a){if(this._attachedElement!=a){return}a.removeEventListener("mousedown",this._onMouseDown);a.removeEventListener("mouseup",this._onMouseUp);a.removeEventListener("mouseout",this._onMouseOut);a.removeEventListener("mousemove",this._onMouseMove);BABYLON.Tools.UnregisterTopRootEvents([{name:"keydown",handler:this._onKeyDown},{name:"keyup",handler:this._onKeyUp},{name:"blur",handler:this._onLostFocus}]);this._attachedElement=null;if(this._reset){this._reset()}};RANDO.HikerCamera.prototype._update=function(){var e=(Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0);var b=(this._oldState!=this._state);if(e){this.rotation.x+=this.cameraRotation.x;this.rotation.y+=this.cameraRotation.y;if(!this.noRotationConstraint){var a=(Math.PI/2)*0.95;if(this.rotation.x>a){this.rotation.x=a}if(this.rotation.x<-a){this.rotation.x=-a}}if(Math.abs(this.cameraRotation.x)<BABYLON.Engine.epsilon){this.cameraRotation.x=0}if(Math.abs(this.cameraRotation.y)<BABYLON.Engine.epsilon){this.cameraRotation.y=0}this.cameraRotation.scaleInPlace(this.inertia)}if(b){console.log(this._oldState+" to "+this._state);var d=this._state;switch(d){case"stop":this._isMoving=true;this._timeline.pause();var c=this;this.moveTo(this._path[0],this._path[1],this.returnSpeed,function(){c._timeline.pause(0);c._isMoving=false});break;case"play":this._timeline.play();break;case"pause":this._timeline.pause();break;case"rewind":this._timeline.reverse();break;case"forward":this._timeline.play()}this._oldState=this._state}};RANDO.HikerCamera.prototype._getViewMatrix=function(){BABYLON.Vector3.FromFloatsToRef(0,0,1,this._referencePoint);if(!this.lockedTarget){if(this.upVector.x!=0||this.upVector.y!=1||this.upVector.z!=0){BABYLON.Matrix.LookAtLHToRef(BABYLON.Vector3.Zero(),this._referencePoint,this.upVector,this._lookAtTemp);BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix);this._lookAtTemp.multiplyToRef(this._cameraRotationMatrix,this._tempMatrix);this._lookAtTemp.invert();this._tempMatrix.multiplyToRef(this._lookAtTemp,this._cameraRotationMatrix)}else{BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}BABYLON.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint);this.position.addToRef(this._transformedReferencePoint,this._currentTarget)}else{this._currentTarget.copyFrom(this._getLockedTargetPosition())}BABYLON.Matrix.LookAtLHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix);return this._viewMatrix};RANDO.HikerCamera.prototype.setPath=function(a){var c=this._path;if(c.length){c=[]}for(var b=0;b<a.length;b+=20){c.push(a[b])}if(a[a.length]!=c[c.length]){c.push(a[a.length])}this._lengthOfBezier=a.length;this.loadPathOnTimeline()};RANDO.HikerCamera.prototype.loadPathOnTimeline=function(){if(!this._path){return}if(!this._lengthOfBezier){this._lengthOfBezier=this._path.length*2}if(this._timeline){this._timeline.clear();this._timeline.kill();this._timeline=null}var h=this;this._timeline=new TimelineLite({onComplete:function(){h._onCompleteTimeline()}});var c=this._lengthOfBezier;var e=this._lengthOfBezier/this.followSpeed;var g={x:this._path[0].x,y:this._path[0].y,z:this._path[0].z};var l=TweenLite.to(g,c,{bezier:this._path,ease:Linear.easeNone});var f,k=20;for(f=0;f<c-k;f++){l.time(f);var b=_.clone(g);l.time(f+k);var a=_.clone(g);var j=RANDO.Utils.angleFromAxis(b,a,BABYLON.Axis.Y);this._timeline.add([TweenLite.to(this.position,(e/c),{x:b.x,y:b.y+RANDO.SETTINGS.CAM_OFFSET,z:b.z,ease:"Linear.easeNone"}),TweenLite.to(this.rotation,(e/c),{directionalRotation:{y:(j+"_short"),useRadians:true},ease:"Linear.easeNone"})])}while(f<c){l.time(f++);this._timeline.add(TweenLite.to(this.position,(e/c),{x:g.x,y:g.y+RANDO.SETTINGS.CAM_OFFSET,z:g.z,ease:"Linear.easeNone"}))}this._timeline.pause(0)};RANDO.HikerCamera.prototype.getTarget=function(){return this._currentTarget};RANDO.HikerCamera.prototype._onCompleteTimeline=function(){this._state="stop"};RANDO.HikerCamera.prototype.moveTo=function(a,c,d,f){var b=RANDO.Utils.angleFromAxis(a,c,BABYLON.Axis.Y);var g=BABYLON.Vector3.Distance(this.position,a);var e=g/d;this._positionTween=TweenLite.to(this.position,e,{x:a.x,y:a.y+RANDO.SETTINGS.CAM_OFFSET,z:a.z,ease:"ease-in",onComplete:function(){if(typeof(f)==="function"){f()}}});this._rotationTween=TweenLite.to(this.rotation,e,{directionalRotation:{x:"0_short",y:(b+"_short"),z:"0_short",useRadians:true},ease:"ease-in"})}})();